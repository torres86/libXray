name: Release Android AAR

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'

env:
  ANDROID_NDK_VERSION: r25c
  GO_VERSION: '1.21'

jobs:
  release-android:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Go ${{ env.GO_VERSION }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        # 不需要安装额外的Python依赖，构建脚本是自包含的
        
    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: ${{ env.ANDROID_NDK_VERSION }}
        
    - name: Set up Go mobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        gomobile init
        
    - name: Build Android AAR
      run: |
        export ANDROID_NDK_HOME=$ANDROID_NDK_ROOT
        python3 build/main.py android
        
    - name: Verify build output
      run: |
        ls -la libXray.aar libXray-sources.jar
        echo "AAR size: $(du -h libXray.aar | cut -f1)"
        echo "Sources size: $(du -h libXray-sources.jar | cut -f1)"
        
    - name: Generate build info
      id: build_info
      run: |
        echo "BUILD_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
        echo "TAG=android-$(date +'%Y%m%d-%H%M%S')-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.build_info.outputs.TAG }}
        name: "Android AAR - ${{ steps.build_info.outputs.BUILD_TIME }}"
        body: |
          🚀 **自动构建的Android AAR库**
          
          📋 **构建信息**
          - **提交SHA**: `${{ github.sha }}`
          - **短SHA**: `${{ steps.build_info.outputs.SHORT_SHA }}`
          - **构建时间**: ${{ steps.build_info.outputs.BUILD_TIME }}
          - **触发分支**: `${{ github.ref_name }}`
          
          📦 **包含文件**
          - `libXray.aar` - Android AAR库文件 (包含所有架构)
          - `libXray-sources.jar` - 源码文件
          
          ⚡ **支持的功能**
          - ✅ HTTP延迟测试 (`LibXray.ping()`)
          - ✅ **TCP延迟测试** (`LibXray.pingTCP()`) - 新增功能！
          - ✅ Xray配置验证
          - ✅ 统计查询
          - ✅ 地理数据处理
          
          🏗️ **支持的架构**
          - `armeabi-v7a` (32位ARM)
          - `arm64-v8a` (64位ARM) 
          - `x86` (32位x86)
          - `x86_64` (64位x86)
          
          📱 **在Android项目中使用**
          
          1. **下载AAR文件**
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.build_info.outputs.TAG }}/libXray.aar
          ```
          
          2. **添加到项目**
          ```gradle
          // 在 app/build.gradle 中添加
          dependencies {
              implementation files('libs/libXray.aar')
          }
          ```
          
          3. **使用TCP测速**
          ```java
          // 创建请求
          String request = createTCPPingRequest(datDir, configPath, timeout, host, port, proxy);
          // 执行测速
          String result = LibXray.pingTCP(request);
          ```
          
          ---
          *此版本由GitHub Actions自动构建和发布*
        files: |
          libXray.aar
          libXray-sources.jar
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
